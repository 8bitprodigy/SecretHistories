[gd_scene load_steps=7 format=3 uid="uid://dn64eq7oqvcvs"]

[ext_resource type="Script" path="res://scenes/worlds/visibility_mask/visibility_mask.gd" id="1"]

[sub_resource type="Shader" id="1"]
code = "shader_type spatial;
render_mode unshaded, blend_mul;

uniform sampler2D DEPTH_TEXTURE : hint_depth_texture, filter_linear;
uniform sampler2D data_texture : hint_default_white, filter_linear;
uniform vec3 offset;
uniform float view_width;

varying mat4 CAMERA;

void vertex() {
	POSITION = vec4(VERTEX, 1.0);
	CAMERA = INV_VIEW_MATRIX;
}

void fragment() {
	float depth = texture(DEPTH_TEXTURE, SCREEN_UV).x;
	vec3 ndc = vec3(SCREEN_UV, depth) * 2.0 - 1.0;
	vec4 world = CAMERA * INV_PROJECTION_MATRIX * vec4(ndc, 1.0);
	vec3 world_position = world.xyz / world.w;
	vec2 uv = (world_position.xz - offset.xz)/(view_width) + vec2(0.5);
	float mask = texture(data_texture, uv).r;
//	mask = step(0.5, mask);
	ALBEDO = vec3(mask);
//	ALBEDO = vec3(fract(10.0*uv), 0);
}"

[sub_resource type="ShaderMaterial" id="2"]
render_priority = 100
shader = SubResource("1")
shader_parameter/offset = null
shader_parameter/view_width = null

[sub_resource type="QuadMesh" id="3"]
size = Vector2(2, 2)

[sub_resource type="Shader" id="6"]
code = "shader_type spatial;
render_mode diffuse_toon, specular_disabled;

void fragment() {
	ALBEDO = vec3(1);
}"

[sub_resource type="ShaderMaterial" id="7"]
render_priority = 0
shader = SubResource("6")

[node name="VisibilityMask" type="MeshInstance3D"]
process_priority = 100
material_override = SubResource("2")
extra_cull_margin = 16384.0
mesh = SubResource("3")
script = ExtResource("1")
resolution = 1024

[node name="SubViewport" type="SubViewport" parent="."]
handle_input_locally = false
gui_snap_controls_to_pixels = false
size = Vector2i(2, 2)
render_target_update_mode = 3

[node name="VisibilityAgent" type="Node3D" parent="SubViewport"]

[node name="SpotLight3D" type="SpotLight3D" parent="SubViewport/VisibilityAgent"]
transform = Transform3D(1, 0, 0, 0, -4.37114e-08, 1, 0, -1, -4.37114e-08, 0, 16, 0)
shadow_enabled = true
spot_range = 32.0
spot_angle = 20.0

[node name="Camera3D" type="Camera3D" parent="SubViewport"]
transform = Transform3D(1, 0, 0, 0, -4.37114e-08, 1, 0, -1, -4.37114e-08, 0, 2, 0)
projection = 1
current = true
near = 1.0
far = 3.0

[node name="MeshInstance3D" type="MeshInstance3D" parent="SubViewport"]
material_override = SubResource("7")
cast_shadow = 2
